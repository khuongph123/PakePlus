<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH·ªêNG K√ä S·ªê LI·ªÜU CSBM C·ª¶A L·ª∞C L∆Ø·ª¢NG AN NINH</title>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { background: #f7fafd; font-family: 'Segoe UI', sans-serif; margin: 0; }
        .container { max-width: 98vw; margin: 18px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0, 2, 8, 0.08); padding: 24px; }
        .header-section { margin-bottom: 20px; }
        .main-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .main-header .phong { font-size: 18px; font-weight: bold; color: #1b3a7a; font-family: 'Times New Roman', serif; }
        .main-header h2 { font-size: 22px; color: #1b3a7a; text-transform: uppercase; text-align: center; flex-grow: 1; font-family: 'Times New Roman', serif; }
        .date-row { display: flex; justify-content: center; align-items: center; margin-top: 15px; }
        .date-row label { font-size: 16px; font-weight: bold; margin-right: 8px; color: #1b3a7a; }
        .date-row input[type="date"] { font-size: 16px; padding: 6px 12px; border-radius: 6px; border: 1px solid #aaa; }
        .actions { display: flex; justify-content: center; gap: 24px; margin: 28px 0 16px 0; flex-wrap: wrap; }
        .btn { border: none; border-radius: 10px; padding: 14px 32px; font-size: 18px; color: #fff; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2); min-width: 160px; justify-content: center; text-decoration: none; }
        .btn:hover { opacity: 0.9; transform: scale(1.05); box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
        .btn-add { background: linear-gradient(90deg, #00b09b, #96c93d); }
        .btn-save { background: linear-gradient(90deg, #43e97b, #38f9d7); }
        .btn-view { background: linear-gradient(90deg, #2193b0, #6dd5ed); }
        .btn-reset { background: linear-gradient(90deg, #ff5858, #f09819); }
        .btn-export { background: linear-gradient(90deg, #fc6076, #ff9a44); }
        .btn-small { font-size:11px; padding:4px 8px; border-radius:5px; min-width: unset !important; box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important; }
        .table-container { overflow-x: auto; border: 1px solid #ccc; }
        table { border-collapse: collapse; background: white; width: 100%; table-layout: fixed; font-family: 'Times New Roman', serif; font-size: 12px; }
        th, td { border: 1px solid #444; padding: 3px 2px; text-align: center; vertical-align: middle; word-wrap: break-word; }
        thead th { background: #e3eeff; color: #1b3a7a; font-weight: bold; }
        tbody tr:hover { background-color: #eff6ff; }
        .total-row { background: #fff3cd; font-weight: bold; }
        .guide-row { font-weight: bold; background: #f0f0f0; font-size: 11px; }
        .input-cell input { width: 100%; box-sizing: border-box; border: none; background: transparent; text-align: center; font-size: 12px; font-family: 'Times New Roman', serif; padding: 3px 2px; }
        .input-cell input:focus { background: #e3f2fd; outline: 2px solid #2196F3; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .archive-section, .aggregate-section { width: 80%; max-width: 900px; margin: 26px auto 0 auto; border-radius: 15px; box-shadow: 0 4px 24px rgba(0, 2, 8, 0.11); background: #f9fcff; padding: 22px 28px; }
        .section-title { font-size: 20px; font-weight: bold; color: #15406a; margin-bottom: 12px; text-align: center; }
        .archive-list-wrap, .agg-results-list { max-height: 246px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
        .archive-list, .agg-results-list-table { width: 100% !important; table-layout: auto; }
        .archive-list tr td, .agg-results-list-table tr td { border: none; border-bottom: 1px solid #eee; padding: 8px 10px; font-size: 16px; text-align: left; vertical-align: middle; }
        .archive-list tr:last-child td, .agg-results-list-table tr:last-child td { border-bottom: none; }
        .archive-row-actions { display: flex; gap: 8px; }
        .agg-search-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 8px 0 14px 0; flex-wrap: wrap; }
        .agg-search-row label { font-size: 18px; vertical-align: middle; }
        .agg-search-row input { font-size: 18px; padding: 8px; }
        .agg-results-list td { font-size: 18px; padding: 8px; vertical-align: middle; }
        .agg-table-wrap { margin-top: 18px; }
        .agg-checkbox { transform: scale(1.4); margin-right: 8px; vertical-align: middle; }
    </style>
</head>
<body>
<a href="dashboard.html" style="display: inline-block; padding: 10px 20px; margin: 20px; font-size: 1rem; font-weight: 700; color: white; background-color: #6c757d; border-radius: 8px; text-decoration: none;">‚¨ÖÔ∏è Quay l·∫°i Dashboard</a>
<div class="container">
  <div class="header-section">
      <div class="main-header">
          <div class="phong">PH√íNG PA06</div>
          <h2>TH·ªêNG K√ä S·ªê LI·ªÜU CSBM C·ª¶A L·ª∞C L∆Ø·ª¢NG AN NINH</h2>
          <div class="phong" style="visibility: hidden;">PH√íNG PA06</div>
      </div>
      <div class="date-row">
        <label for="date">Ng√†y b√°o c√°o:</label>
        <input type="date" id="date" required>
      </div>
  </div>

  <div class="table-container">
    <table id="main-table">
         <thead>
            <tr>
                <th rowspan="3">TT</th><th rowspan="3">ƒê∆°n v·ªã</th><th rowspan="3">T·ªïng s·ªë CSBM c≈©</th><th colspan="2">K·∫øt th√∫c</th>
                <th rowspan="3">M·ªõi x√¢y d·ª±ng</th><th rowspan="3">T·ªïng s·ªë CSBM hi·ªán c√≥</th><th colspan="4">Ph√¢n lo·∫°i</th>
                <th colspan="4">Nhi·ªám v·ª•</th><th colspan="7">B·ªë tr√≠ CSBM</th><th colspan="10" rowspan="2">Th√†nh ph·∫ßn CSBM</th>
                <th rowspan="3">S·ªë CSBM hi·ªán c√≥ ƒëang s·ª≠ d·ª•ng vai LLBM</th><th colspan="2" rowspan="2">H·ªì s∆°</th>
            </tr>
            <tr>
                <th rowspan="2" class="vertical-text">Thanh lo·∫°i</th><th rowspan="2">Chuy·ªÉn lo·∫°i</th><th rowspan="2">Kh√°</th>
                <th rowspan="2">TB</th><th rowspan="2">K√©m</th><th rowspan="2">Ch∆∞a ph√¢n lo·∫°i</th><th rowspan="2">ƒê·ªëi t∆∞·ª£ng KTNV</th>
                <th rowspan="2">ƒê·ªëi t∆∞·ª£ng QLNV</th><th rowspan="2">ƒê·ªëi t∆∞·ª£ng CA</th><th rowspan="2">Kh√°c</th><th rowspan="2">ƒê·ªãa b√†n</th>
                <th rowspan="2">M·ª•c ti√™u</th><th rowspan="2">Tuy·∫øn</th><th rowspan="2">Lƒ©nh v·ª±c</th><th rowspan="2">T·ªï ch·ª©c</th>
                <th rowspan="2">Chuy√™n ƒë·ªÅ</th><th rowspan="2">Kh√°c</th>
            </tr>
            <tr>
                <th>Nh√¢n vi√™n c∆° quan ƒë·∫∑c bi·ªát n∆∞·ªõc ngo√†i</th><th>Ng∆∞·ªùi n∆∞·ªõc ngo√†i, Vi·ªát ki·ªÅu</th><th>Ng∆∞·ªùi c·∫ßm ƒë·∫ßu ƒë·∫ßu ƒë·∫£ng ph√°i Pƒê, t·ªï ch·ª©c li√™n quan ANQG</th>
                <th>H·ªìng y, T·ªïng gi√°m m·ª•c</th><th>Gi√°m m·ª•c, Ph√≥ gi√°m m·ª•c, linh m·ª•c</th><th>M·ª•c s∆∞, h√≤a th∆∞·ª£ng</th>
                <th>Ch·ª©c s·∫Øc, t√¥n gi√°o c√≤n l·∫°i</th><th>Ng∆∞·ªùi c√≥ uy t√≠n trong t√¥n gi√°o </th><th>Ng∆∞·ªùi c√≥ uy t√≠n trong d√¢n t·ªôc</th>
                <th>Lo·∫°i kh√°c</th><th>ƒê√£ ƒëƒÉng k√Ω</th><th>Ch∆∞a ƒëƒÉng k√Ω</th>
            </tr>
            <tr class="guide-row">
                <td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td>
                <td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td><td>19</td><td>20</td>
                <td>21</td><td>22</td><td>23</td><td>24</td><td>25</td><td>26</td><td>27</td><td>28</td><td>29</td><td>30</td>
                <td>31</td><td>32</td><td>33</td><td>34</td><td>35</td>
            </tr>
         </thead>
        <tbody id="table-body"></tbody>
        <tfoot id="table-foot"></tfoot>
    </table>
  </div>

  <div class="actions">
    <button class="btn btn-add" onclick="addNewRow()"><span>‚ûï</span> Th√™m d√≤ng</button>
    <button class="btn btn-save" onclick="saveData()"><span>üíæ</span> L∆∞u</button>
    <button class="btn btn-view" onclick="loadData()">üëÅÔ∏è Xem</button>
    <button class="btn btn-reset" onclick="resetForm()"><span>üóëÔ∏è</span> L√†m m·ªõi</button>
    <button class="btn btn-export" onclick="exportMainWord()"><span>üìÑ</span> Xu·∫•t Word</button>
  </div>

  <div class="archive-section">
    <div class="section-title">D·ªØ li·ªáu ƒë√£ l∆∞u tr·ªØ</div>
    <div class="archive-list-wrap">
      <table class="archive-list" id="archive-list"></table>
    </div>
  </div>

  <div class="aggregate-section">
    <div class="section-title">T·ªïng h·ª£p s·ªë li·ªáu</div>
    <div class="agg-search-row">
      <label>T·ª´ ng√†y:</label>
      <input type="date" id="agg-date-from">
      <label>ƒê·∫øn ng√†y:</label>
      <input type="date" id="agg-date-to">
      <button class="btn btn-view btn-small" onclick="searchByDateRange()">T√¨m ki·∫øm</button>
      <button class="btn btn-add btn-small" onclick="aggregateSelected()">T·ªïng h·ª£p</button>
    </div>
    <div class="agg-results-list">
        <table class="agg-results-list-table" id="agg-results-list-table"></table>
    </div>
    <div class="agg-table-wrap" id="agg-table-wrap"></div>
  </div>
</div>

<script>
const NUM_COLS = 35;
const STORAGE_PREFIX = 'csbm_';
const NUM_EMPTY_ROWS = 5;

// ===== START: C√ÅC H√ÄM ƒê∆Ø·ª¢C TH√äM V√Ä CH·ªàNH S·ª¨A =====

// Helper function ƒë·ªÉ ƒë·ªãnh d·∫°ng s·ªë (·∫©n s·ªë 0)
function formatNumber(num) {
    const n = parseInt(num || 0);
    return n > 0 ? n : '';
}

function calcTotal() {
    const rows = document.querySelectorAll('#table-body tr.data-row');
    for(let c = 3; c <= NUM_COLS; c++) {
        let sum = 0;
        rows.forEach(row => {
            const input = row.querySelector(`td:nth-child(${c}) input`);
            if(input) sum += parseInt(input.value || 0);
        });
        const totalCell = document.getElementById(`total_${c}`);
        if(totalCell) {
            // Hi·ªÉn th·ªã t·ªïng, kh√¥ng ·∫©n s·ªë 0 tr√™n giao di·ªán ƒë·ªÉ ng∆∞·ªùi d√πng ti·ªán theo d√µi
            totalCell.innerText = sum; 
        }
    }
}

// H√†m exportWord ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ ·∫©n s·ªë 0
function exportMainWord() {
    const tableClone = document.getElementById('main-table').cloneNode(true);
    
    // X·ª≠ l√Ω c√°c √¥ d·ªØ li·ªáu
    tableClone.querySelectorAll('tbody input').forEach(input => { 
        const cell = input.parentElement; 
        cell.innerText = formatNumber(input.value); 
    });

    // X·ª≠ l√Ω d√≤ng t·ªïng c·ªông
    tableClone.querySelectorAll('tfoot td').forEach(td => {
        if (td.id && td.id.startsWith('total_')) {
            td.innerText = formatNumber(td.innerText);
        }
    });

    const date = document.getElementById('date').value;
    const title = 'TH·ªêNG K√ä S·ªê LI·ªÜU CSBM C·ª¶A L·ª∞C L∆Ø·ª¢NG AN NINH';
    const subTitle = date ? `(Ng√†y ${formatDate(date)})` : '';
    const htmlContent = generateWordHtml(tableClone.outerHTML, title, subTitle, 'PH√íNG PA');
    saveAs(new Blob(['\ufeff', htmlContent], {type: 'application/msword'}), `ThongKeCSCS_${date || 'Moi'}.doc`);
}

// H√†m aggregateSelected ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ ·∫©n s·ªë 0
function aggregateSelected() {
    const checked = Array.from(document.querySelectorAll('input[name="agg"]:checked')).map(e => e.value);
    if (checked.length === 0) return alert('Vui l√≤ng t√¨m ki·∫øm v√† ch·ªçn √≠t nh·∫•t 1 b√°o c√°o ƒë·ªÉ t·ªïng h·ª£p!');
    
    const mergedData = new Map();
    checked.forEach(date => {
        let data = JSON.parse(localStorage.getItem(STORAGE_PREFIX + date) || '[]');
        data.forEach(rowData => {
            const unitName = (rowData[0] || '').trim();
            if (!unitName) return;

            const numericalData = rowData.slice(1).map(val => parseInt(val || 0));
            if (mergedData.has(unitName)) {
                const existingData = mergedData.get(unitName);
                for (let i = 0; i < numericalData.length; i++) existingData[i] += numericalData[i];
            } else {
                mergedData.set(unitName, numericalData);
            }
        });
    });

    let aggData = Array.from(mergedData.entries()).map(([unitName, values]) => [unitName, ...values]);
    aggData.sort((a, b) => a[0].localeCompare(b[0]));

    const aggTable = document.getElementById('main-table').cloneNode(true);
    aggTable.id = 'agg-table';
    aggTable.querySelectorAll('input').forEach(i => i.remove()); // X√≥a th·∫ª input
    const aggBody = aggTable.querySelector('tbody');
    aggBody.innerHTML = '';
    
    aggData.forEach((rowData, index) => {
        let tr = aggBody.insertRow();
        tr.innerHTML = `<td class="row-number">${index + 1}</td>`;
        for (let c = 0; c < rowData.length; c++) {
            // ·∫®n s·ªë 0 trong b·∫£ng t·ªïng h·ª£p
            const cellValue = (c === 0) ? rowData[c] : formatNumber(rowData[c]);
            tr.insertCell(c + 1).innerText = cellValue;
        }
    });

    const aggFoot = aggTable.querySelector('tfoot');
    const totals = Array(NUM_COLS - 2).fill(0);
    aggData.forEach(rowData => {
        for (let c = 1; c < rowData.length; c++) {
            totals[c - 1] += parseInt(rowData[c] || 0);
        }
    });
    // ·∫®n s·ªë 0 trong d√≤ng t·ªïng c·ªông c·ªßa b·∫£ng t·ªïng h·ª£p
    aggFoot.querySelector('tr').innerHTML = `<td colspan="2">T·ªïng c·ªông</td>${totals.map(t => `<td>${formatNumber(t)}</td>`).join('')}`;
    
    const exportButtonHtml = `<div style="margin-top: 15px; text-align: center;"><button class="btn btn-export" onclick="exportAggregatedWord()"><span>üìÑ</span> Xu·∫•t Word T·ªïng H·ª£p</button></div>`;
    document.getElementById('agg-table-wrap').innerHTML = `<h3 style="font-size:18px; font-weight:bold; color:#1b3a7a; margin-top:15px; text-align:center;">B·∫£ng t·ªïng h·ª£p t·ª´ ${checked.length} b√°o c√°o</h3>${aggTable.outerHTML}${exportButtonHtml}`;
}

// ===== END: C√ÅC H√ÄM ƒê∆Ø·ª¢C TH√äM V√Ä CH·ªàNH S·ª¨A =====


// === C√ÅC H√ÄM G·ªêC GI·ªÆ NGUY√äN ===

function renderTable(data = []) {
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = '';
    const rowsToRender = data.length > 0 ? data : Array(NUM_EMPTY_ROWS).fill(Array(NUM_COLS - 1).fill(''));
    rowsToRender.forEach(rowData => addNewRow(false, rowData));
    renderFooter();
    calcTotal();
}

function renderFooter() {
    const tableFoot = document.getElementById('table-foot');
    let footHtml = '<tr class="total-row"><td colspan="2">T·ªïng c·ªông</td>';
    for(let c = 3; c <= NUM_COLS; c++) {
        footHtml += `<td id="total_${c}">0</td>`;
    }
    footHtml += '</tr>';
    tableFoot.innerHTML = footHtml;
}

function addNewRow(recalc = true, rowData = null) {
    const tableBody = document.getElementById('table-body');
    const newRow = document.createElement('tr');
    newRow.className = 'data-row';
    const rowNum = tableBody.rows.length + 1;
    let rowHtml = `<td class="row-number">${rowNum}</td>`;
    for(let c = 2; c <= NUM_COLS; c++) {
        const value = rowData ? rowData[c-2] : '';
        const inputType = c === 2 ? 'text' : 'number';
        rowHtml += `<td class="input-cell"><input type="${inputType}" oninput="calcTotal()" value="${value}" /></td>`;
    }
    newRow.innerHTML = rowHtml;
    tableBody.appendChild(newRow);
    if(recalc) calcTotal();
}

function resetForm(ask=true) {
    if (ask && !confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒëang nh·∫≠p tr√™n b·∫£ng?')) return;
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    renderTable([]);
}

function saveData() {
    const date = document.getElementById('date').value;
    if(!date) return alert('Vui l√≤ng nh·∫≠p ng√†y b√°o c√°o!');
    let data = [];
    document.querySelectorAll('#table-body tr.data-row').forEach(row => {
        let rowData = [];
        let hasValue = false;
        row.querySelectorAll('input').forEach(input => {
            const val = input.value || '';
            rowData.push(val);
            if (val) hasValue = true;
        });
        if (hasValue) data.push(rowData);
    });
    localStorage.setItem(STORAGE_PREFIX + date, JSON.stringify(data));
    alert('ƒê√£ l∆∞u d·ªØ li·ªáu cho ng√†y '+formatDate(date));
    updateArchiveList();
}

function loadData(date) {
    date = date || document.getElementById('date').value;
    if(!date) return alert('Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ xem d·ªØ li·ªáu!');
    let data = localStorage.getItem(STORAGE_PREFIX + date);
    if(!data) {
        resetForm(false);
        // Kh√¥ng hi·ªán th√¥ng b√°o khi kh√¥ng c√≥ d·ªØ li·ªáu
        return;
    }
    document.getElementById('date').value = date;
    renderTable(JSON.parse(data));
}

function formatDate(d) {
    if(!d) return '';
    const [y,m,day] = d.split('-');
    return `${day}/${m}/${y}`;
}

function updateArchiveList() {
    const tbl = document.getElementById('archive-list');
    tbl.innerHTML = '';
    let arr = [];
    for(let i=0; i<localStorage.length; i++) {
        let k = localStorage.key(i);
        if(k.startsWith(STORAGE_PREFIX)) arr.push(k.replace(STORAGE_PREFIX,''));
    }
    arr.sort((a,b)=>b.localeCompare(a));
    if (arr.length > 0) {
        arr.forEach(d => {
            const row = tbl.insertRow();
            row.innerHTML = `<td>${formatDate(d)}</td>
            <td style="text-align:right;"><div class="archive-row-actions">
                <button class="btn btn-view btn-small" title="Xem" onclick="loadData('${d}')">üëÅÔ∏è</button>
                <button class="btn btn-reset btn-small" style="background: #e74c3c;" title="X√≥a" onclick="deleteData('${d}')">üóëÔ∏è</button>
            </div></td>`;
        });
    } else {
        tbl.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#888;">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o.</td></tr>';
    }
}

function deleteData(date) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn b√°o c√°o ng√†y ${formatDate(date)}?`)) return;
    localStorage.removeItem(STORAGE_PREFIX + date);
    updateArchiveList();
    if (document.getElementById('date').value === date) resetForm(false);
    alert('ƒê√£ x√≥a b√°o c√°o.');
}

function searchByDateRange() {
    const listDiv = document.getElementById('agg-results-list-table');
    listDiv.innerHTML = '';
    const fromDate = document.getElementById('agg-date-from').value;
    const toDate = document.getElementById('agg-date-to').value;
    if (!fromDate || !toDate) return;
    if (fromDate > toDate) return alert('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c!');
    let arr = [];
    for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        if (key.startsWith(STORAGE_PREFIX) && key.substring(STORAGE_PREFIX.length) >= fromDate && key.substring(STORAGE_PREFIX.length) <= toDate) {
            arr.push(key.replace(STORAGE_PREFIX, ''));
        }
    }
    arr.sort((a, b) => b.localeCompare(a));
    if (arr.length > 0) {
        arr.forEach(d => {
            const row = listDiv.insertRow();
            row.innerHTML = `<td><input type="checkbox" name="agg" value="${d}" class="agg-checkbox"></td><td>${formatDate(d)}</td>`;
        });
    } else {
        listDiv.innerHTML = `<tr><td colspan="2" style="color:#888;padding:4px; text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
    }
}

function generateWordHtml(tableContent, title, subTitle, leftTitle) {
    let css = `@page WordSection1 { size: 1190.55pt 841.95pt; mso-page-orientation: landscape; margin:0.5in; } div.WordSection1 { page: WordSection1; } table { border-collapse: collapse; width:100%; font-size:9pt; table-layout: fixed; } th,td { border:1px solid #000; padding:2px; text-align:center; vertical-align:middle; word-wrap: break-word; } .vertical-text { writing-mode: tb-rl; mso-rotate: 90; } h1, h2 { text-align:center; font-family:'Times New Roman', Times, serif; margin: 5px 0; } h1 {font-size: 14pt; font-weight:bold;} h2 {font-size: 12pt; font-weight:normal;} .header-left { text-align:left; font-size:12pt; font-weight: bold; } th, .total-row, .guide-row, .row-number { background-color: #ffffff !important; color: #000000 !important; font-weight: bold; }`;
    const signatureHtml = `<table style="width:100%; border:none; margin-top:40px; font-size:12pt; font-family:'Times New Roman', Times, serif;"><tr><td style="width:50%; text-align:center; border:none; font-weight:bold;">L√ÉNH ƒê·∫†O PH√ä DUY·ªÜT</td><td style="width:50%; text-align:center; border:none; font-weight:bold;">C√ÅN B·ªò TH·ªêNG K√ä</td></tr></table>`;
    return `<html><head><meta charset="utf-8"><style>${css}</style></head><body><div class="WordSection1"><table style="width:100%; border:none;"><tr><td style="width:50%; border:none; text-align:left;" class="header-left">${leftTitle}</td><td style="width:50%; border:none;"></td></tr></table><h1>${title}</h1><h2>${subTitle}</h2>${tableContent}${signatureHtml}</div></body></html>`;
}

function exportAggregatedWord() {
    const table = document.getElementById('agg-table');
    if (!table) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu t·ªïng h·ª£p ƒë·ªÉ xu·∫•t!');
    const fromDate = document.getElementById('agg-date-from').value;
    const toDate = document.getElementById('agg-date-to').value;
    const title = 'TH·ªêNG K√ä S·ªê LI·ªÜU CSBM C·ª¶A L·ª∞C L∆Ø·ª¢NG AN NINH';
    const subTitle = (fromDate && toDate) ? `(T·ª´ ng√†y ${formatDate(fromDate)} ƒë·∫øn ng√†y ${formatDate(toDate)})` : '(T·ªïng h·ª£p)';
    // B·∫£ng ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh d·∫°ng ƒë·ªÉ ·∫©n s·ªë 0, n√™n c√≥ th·ªÉ xu·∫•t tr·ª±c ti·∫øp
    const htmlContent = generateWordHtml(table.outerHTML, title, subTitle, 'PH√íNG PA');
    const fileName = `TongHop_CSCS_${fromDate}_den_${toDate}.doc`;
    saveAs(new Blob(['\ufeff', htmlContent], {type: 'application/msword'}), fileName);
}

document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
  renderTable([]);
  updateArchiveList();
});
</script>
</body>
</html>