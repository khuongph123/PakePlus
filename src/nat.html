<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Th·ªëng k√™ s·ªë li·ªáu NAT</title>
    <style>
        body { background: #f0f2f5; font-family: 'Times New Roman', serif; margin: 0; font-size: 14px; }
        .container { max-width: 98vw; margin: 15px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0, 2, 8, 0.08); padding: 24px; }
        .header-section { margin-bottom: 20px; text-align: center; }
        .main-header h2 { font-size: 24px; color: #1b3a7a; text-transform: uppercase; font-weight: bold; margin: 0; }
        .date-row { display: flex; justify-content: center; align-items: center; margin-top: 15px; }
        .date-row label { font-size: 16px; font-weight: bold; margin-right: 8px; color: #1b3a7a; }
        .date-row input[type="date"] { font-size: 16px; padding: 6px 12px; border-radius: 6px; border: 1px solid #aaa; }
        .actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 28px 0; }
        .btn { border: none; border-radius: 6px; padding: 10px 20px; font-size: 15px; color: #fff; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 7px; transition: 0.18s; }
        .btn-add { background: #28a745; }
        .btn-save { background: linear-gradient(90deg,#43e97b,#38f9d7); }
        .btn-view { background: linear-gradient(90deg,#2193b0,#6dd5ed); }
        .btn-reset { background: linear-gradient(90deg,#ff5858,#f09819); }
        .btn-export { background: linear-gradient(90deg,#fc6076,#ff9a44); }
        .btn-edit { background: #ffd600; color: #222; }
        .btn-small { font-size:11px; padding:4px 8px; border-radius:5px; }
        .btn:hover { opacity: 0.88; transform: translateY(-2px); }
        .table-container { overflow-x: auto; border: 1px solid #ccc; }
        table { border-collapse: collapse; background: white; width: 100%; table-layout: fixed; }
        th, td { border: 1px solid #000; padding: 3px 1px; text-align: center; vertical-align: middle; font-size: 11px; word-wrap: break-word; }
        thead th { background: #e3eeff; color: #1b3a7a; font-weight: bold; white-space: normal; }
        th[rowspan="3"] { min-width: 25px; }
        th[style*="width: 150px"] { width: 120px; }
        tbody tr:hover { background-color: #eff6ff; }
        .total-row { background: #fff3cd; font-weight: bold; }
        .guide-row td { font-weight: bold; background: #f0f0f0; color: #555; padding: 2px; }
        .input-cell input { width: 100%; box-sizing: border-box; border: none; background: transparent; text-align: center; font-size: 11px; font-family: 'Times New Roman', serif; padding: 3px; }
        .input-cell input:focus { background: #e3f2fd; outline: 1px solid #2196F3; }
        .delete-row-btn { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 9px; cursor: pointer; font-family: 'Segoe UI', sans-serif; font-weight: bold; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .archive-section, .aggregate-section { margin-top: 25px; background: #f6fafd; border-radius: 8px; padding: 16px; }
        .section-title { font-size: 16px; font-weight: bold; color: #1976d2; margin-bottom: 12px; }
        .archive-list-wrap { max-height: 150px; overflow-y: auto; border-radius:4px; border:1px solid #c2d1e0; background: #f8fafc; }
        .archive-list { width: 100%; font-size: 12px; }
        .archive-list tr td { padding: 6px 4px; border-color: #ddd; }
        .archive-row-actions { display: flex; gap: 4px; justify-content: center; }
        .aggregate-section { margin-top: 25px; }
        .agg-search-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .agg-search-row label { font-size: 16px; font-weight: 600; color: #1b3a7a; }
        /* CH·ªàNH S·ª¨A: Thay ƒë·ªïi style cho input ng√†y th√°ng */
        .agg-search-row input { font-size: 16px; padding: 8px 12px; border-radius: 6px; border: 1px solid #aaa; }
        .agg-results-list { margin-top: 8px; max-height: 200px; overflow-y: auto; border-radius:4px; border:1px solid #c2d1e0; background: #fff; padding: 5px;}
        .agg-results-list table { font-size: 12px; }
        .agg-results-list td { padding: 5px; border-color: #eee; }
        .agg-checkbox { transform: scale(1.2); margin-right: 8px; }
        .agg-row-actions { display: flex; gap: 3px; justify-content: center; }
        .agg-table-wrap { margin-top: 15px;}
		/* D√°n ƒëo·∫°n m√£ n√†y v√†o trong th·∫ª <style> */
    </style>
</head>
<body>
<a href="dashboard.html" style="display: inline-block; padding: 10px 20px; margin: 20px; font-size: 1rem; font-weight: 700; color: white; background-color: #6c757d; border-radius: 8px; text-decoration: none;">‚¨ÖÔ∏è Quay l·∫°i Dashboard</a>

<div class="container">
    <div class="header-section">
        <div class="main-header">
            <h2>TH·ªêNG K√ä S·ªê LI·ªÜU NH√Ä AN TO√ÄN, H·ªòP TH∆Ø B√ç M·∫¨T C·ª¶A L·ª∞C L∆Ø·ª¢NG AN NINH</h2>
        </div>
        <div class="date-row">
            <label for="date">Ng√†y b√°o c√°o:</label>
            <input type="date" id="date" required>
        </div>
    </div>

    <div class="table-container">
        <table id="main-table">
             <thead>
                <tr>
                    <th rowspan="3" style="width: 3%;">X√≥a</th>
                    <th rowspan="3" style="width: 3%;">STT</th>
                    <th rowspan="3" style="width: 12%;">ƒê∆°n v·ªã</th>
                    <th colspan="6">T√åNH H√åNH NH√Ä AN TO√ÄN</th>
                    <th colspan="4">HO·∫†T ƒê·ªòNG NV NH√Ä AN TO√ÄN</th>
                    <th colspan="3">AN NINH NAT</th>
                    <th rowspan="3">T·ªïng s·ªë</th>
                    <th rowspan="3">Lo·∫°i</th>
                    <th rowspan="3">M·ªõi x√¢y d·ª±ng</th>
                    <th rowspan="3">T·ªïng s·ªë HTBM hi·ªán c√≥</th>
                    <th colspan="4">PH√ÇN LO·∫†I HTBM</th>
                    <th colspan="2">H·ªí S∆†</th>
                </tr>
                <tr>
                    <th colspan="3">ƒêƒÉng k√Ω h·ªì s∆°</th>
                    <th colspan="3">T√¨nh tr·∫°ng nh√†</th>
                    <th rowspan="2">T·ªïng s·ªë l∆∞·ª£t s·ª≠ d·ª•ng</th>
                    <th rowspan="2">Sinh ho·∫°t l·ª±c l∆∞·ª£ng b√≠ m·∫≠t</th>
                    <th rowspan="2">B·∫Øt b√≠ m·∫≠t, c√¢u l∆∞u ƒë·ªëi t∆∞·ª£ng</th>
                    <th rowspan="2">Y√™u c·∫ßu nghi·ªáp v·ª• kh√°c</th>
                    <th rowspan="2">B√≠ m·∫≠t, an to√†n</th>
                    <th rowspan="2">C√≥ d·∫•u hi·ªáu l·ªô</th>
                    <th rowspan="2">L·ªô</th>
                    <th rowspan="2">Kh√°</th>
                    <th rowspan="2">Trung b√¨nh</th>
                    <th rowspan="2">Y·∫øu</th>
                    <th rowspan="2">Ch∆∞a ph√¢n lo·∫°i</th>
                    <th rowspan="2">ƒê√£ ƒëƒÉng k√Ω</th>
                    <th rowspan="2">Ch∆∞a ƒëƒÉng k√Ω</th>
                </tr>
                <tr>
                    <th>T·ªïng s·ªë</th>
                    <th>ƒê√£ ƒëƒÉng k√Ω</th>
                    <th>Ch∆∞a ƒëƒÉng k√Ω</th>
                    <th>M·ªõi h√¨nh th√†nh ch∆∞a ƒë∆∞a v√†o s·ª≠ d·ª•ng</th>
                    <th>ƒêang s·ª≠ d·ª•ng</th>
                    <th>H∆∞ h·ªèng xu·ªëng c·∫•p kh√¥ng s·ª≠ d·ª•ng</th>
                </tr>
                 <tr class="guide-row">
                    <td></td>
                    <td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td>
                    <td>9</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td>
                    <td>19</td><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td><td>25</td>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
            <tfoot id="table-foot"></tfoot>
        </table>
    </div>
    
    <div class="actions">
        <button class="btn btn-add" onclick="addUserRow()">‚ûï Th√™m d√≤ng</button>
        <button class="btn btn-save" onclick="saveData()">üíæ L∆∞u</button>
        <button class="btn btn-reset" onclick="resetForm()">üóëÔ∏è L√†m m·ªõi</button>
        <button class="btn btn-export" onclick="exportMainWord()">üìÑ Xu·∫•t Word</button>
    </div>

    <div class="archive-section">
        <div class="section-title">2 &nbsp; D·ªØ li·ªáu ƒë√£ l∆∞u tr·ªØ</div>
        <div class="archive-list-wrap">
          <table class="archive-list" id="archive-list"></table>
        </div>
    </div>

    <div class="aggregate-section">
        <div class="section-title">3 &nbsp; T·ªïng h·ª£p s·ªë li·ªáu</div>
        <div class="agg-search-row">
            <label>T·ª´ ng√†y:</label>
            <input type="text" id="agg-date-from-display" placeholder="dd/mm/yyyy" onfocus="this.type='date'" onblur="formatDisplayDate(this, 'agg-date-from')">
            <input type="date" id="agg-date-from" style="display:none;">
            <label>ƒê·∫øn ng√†y:</label>
            <input type="text" id="agg-date-to-display" placeholder="dd/mm/yyyy" onfocus="this.type='date'" onblur="formatDisplayDate(this, 'agg-date-to')">
            <input type="date" id="agg-date-to" style="display:none;">
            <button class="btn btn-view" onclick="searchByDateRange()">T√¨m ki·∫øm</button>
            <button class="btn btn-add" onclick="aggregateSelected()">T·ªïng h·ª£p</button>
        </div>
        <div class="agg-results-list" id="agg-results"></div>
        <div class="agg-table-wrap" id="agg-table-wrap"></div>
    </div>
</div>

<script>
    const NUM_UNIT_COLS = 1;
    const NUM_NUMERIC_COLS = 23;
    const NUM_INPUT_COLS_PER_ROW = NUM_UNIT_COLS + NUM_NUMERIC_COLS;
    const STORAGE_PREFIX = 'nat_';
    const NUM_EMPTY_ROWS = 5;

    // --- C√ÅC H√ÄM G·ªêC GI·ªÆ NGUY√äN ---
    function renderTable(data = []) {
        const tableBody = document.getElementById('table-body');
        tableBody.innerHTML = '';
        const rowsToRender = data.length > 0 ? data : Array.from({ length: NUM_EMPTY_ROWS }, () => Array(NUM_INPUT_COLS_PER_ROW).fill(''));
        rowsToRender.forEach(rowData => addNewRow(false, rowData));
        updateTableFooter();
        calcTotal();
    }
    
    function updateTableFooter() {
        const tableFoot = document.getElementById('table-foot');
        let footHtml = '<tr class="total-row"><td colspan="3" style="font-weight:bold;">T·ªîNG C·ªòNG</td>';
        for (let c = 1; c <= NUM_NUMERIC_COLS; c++) {
            footHtml += `<td id="total_${c}">0</td>`;
        }
        footHtml += '</tr>';
        tableFoot.innerHTML = footHtml;
    }

    function addUserRow() { addNewRow(true, null); }

    function addNewRow(recalc = true, rowData = null) {
        const tableBody = document.getElementById('table-body');
        const newRow = document.createElement('tr');
        const rowNum = tableBody.rows.length + 1;
        let rowHtml = `<td><button class="delete-row-btn" onclick="deleteCurrentRow(this)">X</button></td>`;
        rowHtml += `<td class="row-number">${rowNum}</td>`;
        for (let c = 0; c < NUM_INPUT_COLS_PER_ROW; c++) {
            const isTextField = (c === 0);
            const value = rowData ? (rowData[c] ?? '') : '';
            const inputType = isTextField ? 'text' : 'number';
            rowHtml += `<td class="input-cell"><input type="${inputType}" value="${value}" oninput="calcTotal()"></td>`;
        }
        newRow.innerHTML = rowHtml;
        tableBody.appendChild(newRow);
        if (recalc) calcTotal();
    }

    function deleteCurrentRow(button) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d√≤ng n√†y?')) return;
        button.closest('tr').remove();
        updateRowNumbers();
        calcTotal();
    }

    function updateRowNumbers() {
        document.querySelectorAll('#table-body tr').forEach((row, index) => {
            row.querySelector('.row-number').textContent = index + 1;
        });
    }

    function calcTotal() {
        for (let c = 1; c <= NUM_NUMERIC_COLS; c++) {
            let sum = 0;
            const cellIndex = 3 + c;
            document.querySelectorAll('#table-body tr').forEach(row => {
                const input = row.querySelector(`td:nth-child(${cellIndex}) input`);
                if (input && input.type === 'number') {
                    const v = parseFloat(input.value);
                    if (!isNaN(v)) sum += v;
                }
            });
            document.getElementById(`total_${c}`).innerText = sum;
        }
    }

    function resetForm(ask = true) {
        if (ask && !confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒëang nh·∫≠p tr√™n b·∫£ng kh√¥ng?')) return;
        document.getElementById('date').valueAsDate = new Date();
        renderTable();
    }

    function saveData() {
        const date = document.getElementById('date').value;
        if (!date) return alert('Vui l√≤ng nh·∫≠p ng√†y b√°o c√°o!');
        const data = [];
        document.querySelectorAll('#table-body tr').forEach(row => {
            const rowData = [];
            let hasValue = false;
            row.querySelectorAll('input').forEach(input => {
                const val = input.value || '';
                rowData.push(val);
                if (val) hasValue = true;
            });
            if (hasValue) data.push(rowData);
        });
        localStorage.setItem(STORAGE_PREFIX + date, JSON.stringify(data));
        alert('ƒê√£ l∆∞u d·ªØ li·ªáu cho ng√†y ' + formatDate(date));
        updateArchiveList();
    }

    function loadData(date) {
        date = date || document.getElementById('date').value;
        if (!date) return alert('Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ xem d·ªØ li·ªáu!');
        const data = localStorage.getItem(STORAGE_PREFIX + date);
        if (!data) {
            resetForm(false);
            return alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho ng√†y ' + formatDate(date));
        }
        document.getElementById('date').value = date;
        renderTable(JSON.parse(data));
    }
    
    function formatDate(d) {
        if (!d) return '';
        const [y, m, day] = d.split('-');
        return `${day}/${m}/${y}`;
    }

    function updateArchiveList() {
        const tbl = document.getElementById('archive-list');
        let html = '';
        const arr = [];
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (k.startsWith(STORAGE_PREFIX)) arr.push(k.replace(STORAGE_PREFIX, ''));
        }
        arr.sort((a,b)=>b.localeCompare(a)); 
        for (const d of arr) {
            html += `<tr>
                <td>${formatDate(d)}</td>
                <td>
                    <div class="archive-row-actions">
                        <button class="btn btn-view btn-small" onclick="loadData('${d}')" title="Xem l·∫°i">üëÅÔ∏è</button>
                        <button class="btn btn-reset btn-small" onclick="deleteData('${d}')" title="X√≥a">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>`;
        }
        tbl.innerHTML = html || '<tr><td colspan="2" style="color:#888; padding: 10px;">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o.</td></tr>';
    }

    function deleteData(date) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn b√°o c√°o ng√†y ${formatDate(date)}?`)) return;
        localStorage.removeItem(STORAGE_PREFIX + date);
        updateArchiveList();
        if (document.getElementById('date').value === date) resetForm(false);
        alert('ƒê√£ x√≥a b√°o c√°o.');
    }

    // --- C√ÅC H√ÄM T·ªîNG H·ª¢P ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T ---

    // H√ÄM M·ªöI: ƒê·ªãnh d·∫°ng l·∫°i input ng√†y sau khi ch·ªçn
    function formatDisplayDate(displayInput, hiddenInputId) {
        const hiddenInput = document.getElementById(hiddenInputId);
        if (displayInput.value) {
            hiddenInput.value = displayInput.value;
            displayInput.type = 'text';
            displayInput.value = formatDate(hiddenInput.value);
        } else {
            hiddenInput.value = '';
        }
    }

    // THAY TH·∫æ H√ÄM searchYear() B·∫∞NG searchByDateRange()
    function searchByDateRange() {
        document.getElementById('agg-table-wrap').innerHTML = ''; // X√≥a b·∫£ng t·ªïng h·ª£p c≈©
        const listDiv = document.getElementById('agg-results');
        listDiv.innerHTML = '';
        const fromDate = document.getElementById('agg-date-from').value;
        const toDate = document.getElementById('agg-date-to').value;

        if (!fromDate || !toDate) {
            return alert('Vui l√≤ng ch·ªçn ƒë·ªß "T·ª´ ng√†y" v√† "ƒê·∫øn ng√†y"!');
        }
        if (fromDate > toDate) {
            return alert('"T·ª´ ng√†y" kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n "ƒê·∫øn ng√†y"!');
        }

        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            const datePart = k.replace(STORAGE_PREFIX, '');
            if (k.startsWith(STORAGE_PREFIX) && datePart >= fromDate && datePart <= toDate) {
                keys.push(k);
            }
        }
        keys.sort().reverse();

        let html = '';
        if (keys.length > 0) {
            html = '<form id="agg-form"><table class="archive-list">';
            keys.forEach(key => {
                const date = key.replace(STORAGE_PREFIX, '');
                html += `<tr>
                            <td><input class="agg-checkbox" type="checkbox" name="agg" value="${date}"></td>
                            <td>${formatDate(date)}</td>
                            <td style="width: 90px;">
                                <div class="agg-row-actions">
                                    <button type="button" class="btn btn-view btn-small" onclick="loadData('${date}')" title="Xem l·∫°i">üëÅÔ∏è</button>
                                    <button type="button" class="btn btn-reset btn-small" onclick="deleteData('${date}')" title="X√≥a">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>`;
            });
            html += '</table></form>';
        } else {
            html = `<div style="text-align:center; color: #888; padding:10px;">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</div>`;
        }
        listDiv.innerHTML = html;
    }

    function aggregateSelected() {
        const form = document.getElementById('agg-form');
        if (!form) return alert('Vui l√≤ng t√¨m ki·∫øm v√† ch·ªçn c√°c b√°o c√°o c·∫ßn t·ªïng h·ª£p!');
        const checked = Array.from(form.elements['agg']).filter(e => e.checked).map(e => e.value);
        if (checked.length === 0) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 b√°o c√°o ƒë·ªÉ t·ªïng h·ª£p!');
        
        const aggregatedData = new Map();
        checked.forEach(date => {
            const data = JSON.parse(localStorage.getItem(STORAGE_PREFIX + date));
            if (data) {
                data.forEach(rowData => {
                    const donvi = (rowData[0] || '').trim();
                    if (!donvi) return;
                    if (!aggregatedData.has(donvi)) {
                        aggregatedData.set(donvi, Array(NUM_INPUT_COLS_PER_ROW).fill(0));
                        aggregatedData.get(donvi)[0] = donvi;
                    }
                    const existingRow = aggregatedData.get(donvi);
                    for (let i = 1; i < rowData.length; i++) {
                        existingRow[i] += (parseFloat(rowData[i]) || 0);
                    }
                });
            }
        });
        const tableData = { body: Array.from(aggregatedData.values()) };
        const tableHtml = createTableHtml(tableData);
        const aggTableWrap = document.getElementById('agg-table-wrap');
        aggTableWrap.innerHTML = tableHtml + `<div style="text-align:center; margin-top:15px;"><button class="btn btn-export" onclick="exportAggWord()">Xu·∫•t B·∫£ng T·ªïng H·ª£p</button></div>`;
    }
    
    function downloadWord(html, filename) {
        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 0);
    }
    
    function generateWordHtml(tableData, title) {
        const tableHtml = createTableHtml(tableData);
        const css = `
            <style>
                @page { size: A4 landscape; margin: 0.5in; }
                body { font-family: 'Times New Roman', serif; font-size: 8pt; }
                .word-title { text-align: center; font-weight: bold; font-size: 16pt; text-transform: uppercase; margin-bottom: 5px; }
                .word-subtitle { text-align: center; font-weight: bold; font-size: 14pt; margin-bottom: 20px; }
                .word-footer { display: flex; justify-content: space-around; margin-top: 40px; font-size: 11pt; font-weight: bold; page-break-inside: avoid; }
                .signature { text-align: center; }
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #000; padding: 2px; text-align: center; vertical-align: middle; word-wrap: break-word; }
                .total-row { font-weight: bold; }
            </style>
        `;
        return `
            <html>
                <head><meta charset="utf-8">${css}</head>
                <body>
                    <div class="word-title">TH·ªêNG K√ä S·ªê LI·ªÜU</div>
                    <div class="word-subtitle">${title}</div>
                    ${tableHtml}
                    <div class="word-footer">
                        <div class="signature">L√ÉNH ƒê·∫†O ƒê∆†N V·ªä<br><br><br><br></div>
                        <div class="signature">C√ÅN B·ªò TH·ªêNG K√ä<br><br><br><br></div>
                    </div>
                </body>
            </html>`;
    }
    
    function createTableHtml(data) {
        let tableHeader = document.getElementById('main-table').querySelector('thead').innerHTML;
        const tempThead = document.createElement('thead');
        tempThead.innerHTML = tableHeader;
        const firstTh = tempThead.querySelector('tr th:first-child');
        if (firstTh) firstTh.remove();
        const firstGuideTd = tempThead.querySelector('tr.guide-row td:first-child');
        if (firstGuideTd) firstGuideTd.remove();
        tableHeader = tempThead.innerHTML;
        let tableBody = '';
        data.body.forEach((rowData, index) => {
            let rowHtml = '<tr>';
            rowHtml += `<td>${index + 1}</td>`;
            rowData.forEach(cellData => {
                rowHtml += `<td>${cellData ?? ''}</td>`;
            });
            rowHtml += '</tr>';
            tableBody += rowHtml;
        });
        const colCount = NUM_NUMERIC_COLS;
        let footerRow = '';
        if (data.body.length > 0) {
            footerRow = '<tr class="total-row">';
            footerRow += `<td colspan="2"><strong>T·ªîNG C·ªòNG</strong></td>`;
            for (let c = 1; c <= colCount; c++) {
                let sum = 0;
                data.body.forEach(rowData => {
                    sum += parseFloat(rowData[c] || 0);
                });
                footerRow += `<td>${sum}</td>`;
            }
            footerRow += '</tr>';
        }
        return `<table><thead>${tableHeader}</thead><tbody>${tableBody}</tbody><tfoot>${footerRow}</tfoot></table>`;
    }

    function exportMainWord() {
        const tableBody = [];
        let hasData = false;
        document.querySelectorAll('#table-body tr').forEach(row => {
            const rowData = [];
            row.querySelectorAll('input').forEach((input) => {
                const val = input.value || '';
                rowData.push(val);
                if (val) hasData = true;
            });
            if (rowData.some(v => v !== '')) tableBody.push(rowData);
        });
        if (!hasData) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
        const date = document.getElementById('date').value;
        const title = `(Ng√†y ${formatDate(date) || '.../.../...'})`;
        const htmlContent = generateWordHtml({ body: tableBody }, title);
        downloadWord(htmlContent, `ThongKe_NAT_${date || 'Moi'}.doc`);
    }
    
    // C·∫¨P NH·∫¨T: Thay ƒë·ªïi c√°ch l·∫•y ti√™u ƒë·ªÅ cho file Word
    function exportAggWord() {
        const wrapper = document.getElementById('agg-table-wrap');
        const table = wrapper ? wrapper.querySelector('table') : null;
        if (!table) return alert('Kh√¥ng c√≥ b·∫£ng t·ªïng h·ª£p ƒë·ªÉ xu·∫•t!');
        const tableBody = [];
        table.querySelectorAll('tbody tr').forEach(row => {
            const rowData = row.querySelectorAll('td');
            tableBody.push(Array.from(rowData).slice(1).map(cell => cell.innerText));
        });
        
        // L·∫•y ng√†y t·ª´ input ƒë·ªÉ ƒë·∫∑t t√™n file v√† ti√™u ƒë·ªÅ
        const fromDate = document.getElementById('agg-date-from').value;
        const toDate = document.getElementById('agg-date-to').value;
        const title = `(T·ªïng h·ª£p t·ª´ ng√†y ${formatDate(fromDate)} ƒë·∫øn ${formatDate(toDate)})`;
        const fileNamePart = fromDate && toDate ? `${fromDate}_den_${toDate}` : 'TongHop';

        const htmlContent = generateWordHtml({ body: tableBody }, title);
        downloadWord(htmlContent, `TongHop_NAT_${fileNamePart}.doc`);
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('date').valueAsDate = new Date();
        // X√≥a d√≤ng g√°n gi√° tr·ªã cho agg-year kh√¥ng c√≤n t·ªìn t·∫°i
        renderTable();
        updateArchiveList();
    });
</script>
</body>
</html>