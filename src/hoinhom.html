<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH·ªêNG K√ä S·ªê LI·ªÜU H·ªòI, NH√ìM TR√äN KH√îNG GIAN M·∫†NG LI√äN QUAN ANQG V√Ä "VAI ·∫¢O"</title>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { background: #f7fafd; font-family: 'Segoe UI', sans-serif; margin: 0; }
        .container { max-width: 98vw; margin: 18px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0, 2, 8, 0.08); padding: 24px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h2 { font-size: 22px; color: #1b3a7a; margin-bottom: 12px; text-transform: uppercase; }
        .date-row { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
        .date-row label { font-size: 16px; font-weight: bold; margin-right: 8px; color: #1b3a7a; }
        .date-row input[type="date"] { font-size: 16px; padding: 6px 12px; border-radius: 6px; border: 1px solid #aaa; }
        .actions { display: flex; justify-content: center; gap: 14px; margin: 22px 0 10px 0; flex-wrap: wrap; }
        .btn { border: none; border-radius: 6px; padding: 10px 20px; font-size: 15px; color: #fff; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 7px; transition: 0.18s; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .btn-add { background: linear-gradient(90deg,#00b09b,#96c93d); }
        .btn-save { background: linear-gradient(90deg,#43e97b,#38f9d7); }
        .btn-view { background: linear-gradient(90deg,#2193b0,#6dd5ed); }
        .btn-reset { background: linear-gradient(90deg,#ff5858,#f09819); }
        .btn-export { background: linear-gradient(90deg,#84fab0,#8fd3f4); }
        .btn-small { font-size:11px; padding:4px 8px; border-radius:5px; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* === CSS T·ªêI ∆ØU CHO B·∫¢NG === */
        .table-container { 
            overflow-x: hidden; /* ·∫®n thanh cu·ªôn ngang */
            border: 1px solid #ccc;
        }
        table { 
            border-collapse: collapse; 
            background: white; 
            width: 100%; /* B·∫£ng r·ªông 100% container */
            table-layout: fixed; /* QUAN TR·ªåNG: Gi√∫p b·∫£ng tu√¢n th·ªß width ƒë√£ ƒë·ªãnh */
            font-size: 12px; /* Gi·∫£m font ch·ªØ ƒë·ªÉ g·ªçn h∆°n */
        }
        th, td { 
            border: 1px solid #444; 
            padding: 3px 2px; /* Gi·∫£m padding */
            text-align: center; 
            vertical-align: middle;
            word-wrap: break-word; /* T·ª± ƒë·ªông xu·ªëng d√≤ng cho n·ªôi dung d√†i */
        }
        /* ============================ */

        thead th { background: #e3eeff; color: #1b3a7a; font-weight: bold; }
        tbody tr:hover { background-color: #eff6ff; }
        .row-label { text-align: left; padding-left: 8px; background: #f6fafd; }
        .row-number { font-weight: bold; background: #e7f1ff; }
        .total-row { background: #fff3cd; font-weight: bold; }
        .guide-row { font-weight: bold; background: #f0f0f0; font-size: 11px; }
        .input-cell input { width: 100%; box-sizing: border-box; border: none; background: transparent; text-align: center; font-size: 12px; padding: 3px 2px; }
        .input-cell input:focus { background: #e3f2fd; outline: 2px solid #2196F3; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .archive-section, .aggregate-section {
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            margin-top: 16px;
            background: #f6fafd;
            border-radius: 8px;
            padding: 16px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .section-title { font-size: 18px; font-weight: bold; color: #1976d2; margin-bottom: 12px; border-bottom: 2px solid #ddd; padding-bottom: 8px; }
        .archive-list-wrap { max-height: 150px; overflow-y: auto; border-radius:4px; border:1px solid #c2d1e0; background: #fff; }
        .archive-list { width: 100%; font-size: 13px; table-layout: auto; } /* Reset table-layout cho b·∫£ng nh·ªè */
        .archive-list tr td { padding: 8px 6px; border-bottom: 1px solid #eee; }
        .archive-list tr:last-child td { border-bottom: none; }
        .archive-row-actions { display: flex; gap: 4px; justify-content: flex-end; }
        .agg-search-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; justify-content: center; }
        .agg-search-row input[type="date"] { font-size: 14px; padding: 6px 10px; border-radius: 4px; border: 1px solid #aaa; }
        
        .agg-results-list { max-height: 150px; overflow-y: auto; background: #fff; border-radius: 4px; border:1px solid #c2d1e0; font-size:13px; }
        .agg-checkbox { transform: scale(1.2); margin-right: 8px; }
        .agg-table-wrap { margin-top: 15px; }
        .delete-row-btn { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; }
    </style>
</head>
<body>
<a href="dashboard.html" style="display: inline-block; padding: 10px 20px; margin: 20px; font-size: 1rem; font-weight: 700; color: white; background-color: #6c757d; border-radius: 8px; text-decoration: none;">‚¨ÖÔ∏è Quay l·∫°i Dashboard</a>

<div class="container">
  
  <div class="header">
    <h2>Th·ªëng k√™ s·ªë li·ªáu h·ªôi nh√≥m tr√™n KGM li√™n quan ANQG v√† "Vai ·∫£o"</h2>
  </div>
  <div class="date-row">
    <label for="date">Ng√†y b√°o c√°o:</label>
    <input type="date" id="date" required>
  </div>

  <div class="table-container">
    <table id="main-table">
        <!-- QUAN TR·ªåNG: ƒê·ªãnh nghƒ©a chi·ªÅu r·ªông c√°c c·ªôt b·∫±ng % ƒë·ªÉ b·∫£ng t·ª± co gi√£n -->
        <colgroup>
            <col style="width: 2.5%;"> <!-- 1. TT -->
            <col style="width: 10%;">  <!-- 2. ƒê∆°n v·ªã -->
            <col style="width: 2.5%;"> <!-- 3 -->
            <col style="width: 2.5%;"> <!-- 4 -->
            <col style="width: 2.5%;"> <!-- 5 -->
            <col style="width: 2.5%;"> <!-- 6 -->
            <col style="width: 2.5%;"> <!-- 7 -->
            <col style="width: 2.5%;"> <!-- 8 -->
            <col style="width: 2.5%;"> <!-- 9 -->
            <col style="width: 2.5%;"> <!-- 10 -->
            <col style="width: 2.5%;"> <!-- 11 -->
            <col style="width: 2.5%;"> <!-- 12 -->
            <col style="width: 4%;">   <!-- 13 -->
            <col style="width: 2.5%;"> <!-- 14 -->
            <col style="width: 4%;">   <!-- 15 -->
            <col style="width: 2.5%;"> <!-- 16 -->
            <col style="width: 2.5%;"> <!-- 17 -->
            <col style="width: 2.5%;"> <!-- 18 -->
            <col style="width: 2.5%;"> <!-- 19 -->
            <col style="width: 2.5%;"> <!-- 20 -->
            <col style="width: 2.5%;"> <!-- 21 -->
            <col style="width: 2.5%;"> <!-- 22 -->
            <col style="width: 2.5%;"> <!-- 23 -->
            <col style="width: 2.5%;"> <!-- 24 -->
            <col style="width: 2.5%;"> <!-- 25 -->
            <col style="width: 2.5%;"> <!-- 26 -->
            <col style="width: 2.5%;"> <!-- 27 -->
            <col style="width: 2.5%;"> <!-- 28 -->
            <col style="width: 2.5%;"> <!-- 29 -->
            <col style="width: 2.5%;"> <!-- 30 -->
            <col style="width: 2.5%;"> <!-- 31 -->
            <col style="width: 2.5%;"> <!-- 32 -->
            <col style="width: 2.5%;"> <!-- 33 -->
            <col style="width: 2.5%;"> <!-- 34 -->
            <col style="width: 2.5%;"> <!-- 35 -->
            <col style="width: 2.5%;"> <!-- 36 -->
            <col style="width: 2.5%;"> <!-- 37 -->
            <col style="width: 2.5%;"> <!-- 38 -->
        </colgroup>
         <thead>
            <tr>
                <th rowspan="4">TT</th>
                <th rowspan="4">ƒê∆°n v·ªã</th>
                <th colspan="17">H·ªôi, nh√≥m tr√™n kh√¥ng gian m·∫°ng li√™n quan ANQG</th>
                <th colspan="19">C√îNG T√ÅC "VAI ·∫¢O"</th>
            </tr>
            <tr>
                <th rowspan="3">T·ªïng s·ªë h·ªôi, nh√≥m c≈©</th>
                <th colspan="2">Ph√°t hi·ªán m·ªõi</th>
                <th colspan="2">ƒê∆∞·ª£c ph√¢n c√¥ng m·ªõi</th>
                <th rowspan="3">S·ªë h·ªôi, nh√≥m ƒë√£ b·ªã ph√° r√£, v√¥ hi·ªáu h√≥a ho·∫∑c t·ª± gi·∫£i t√°n</th>
                <th colspan="7">T·ªïng s·ªë h·ªôi, nh√≥m ƒëang ch·ªß tr√¨ tri·ªÉn khai c√¥ng t√°c AN</th>
                <th colspan="3">ƒê·ªëi t∆∞·ª£ng tham gia h·ªôi, nh√≥m ƒëang qu·∫£n l√Ω, ƒë·∫•u tranh</th>
                <th rowspan="3">S·ªë nh√≥m, fanpage t√≠ch c·ª±c ƒëang qu·∫£n l√Ω, s·ª≠ d·ª•ng</th>
                <th rowspan="3">T·ªïng s·ªë Vai ·∫£o c≈©</th>
                <th colspan="2" rowspan="2">T·ªïng s·ªë k·∫øt th√∫c</th>
                <th colspan="2" rowspan="2">T·ªïng s·ªë x√¢y d·ª±ng m·ªõi</th>
                <th colspan="2" rowspan="2">T·ªïng s·ªë ƒëang qu·∫£n l√Ω, s·ª≠ d·ª•ng</th>
                <th rowspan="3">S·ªë trinh s√°t s·ª≠ d·ª•ng "vai nghi·ªáp v·ª•"</th>
                <th rowspan="3">S·ªë LLBM s·ª≠ d·ª•ng vai "LLBM"</th>
                <th rowspan="3">S·ªë "vai ·∫£o" ti·∫øp c·∫≠n</th>
                <th rowspan="3">S·ªë "vai ·∫£o" l√†m qu·∫£n tr·ªã</th>
                <th colspan="2" rowspan="2">S·ªë "vai ·∫£o" tham gia h·ªôi, nh√≥m k√≠n, b√≠ m·∫≠t, ri√™ng t∆∞</th>
                <th colspan="2" rowspan="2">S·ªë "vai ·∫£o" n·∫Øm t√¨nh h√¨nh chung</th>
                <th colspan="4">Tin " Vai ·∫£o"</th>
            </tr>
            <tr>
                <th rowspan="2">C√¥ng khai</th>
                <th rowspan="2">K√≠n, b√≠ m·∫≠t, ri√™ng t∆∞</th>
                <th rowspan="2">C√¥ng khai</th>
                <th rowspan="2">K√≠n, b√≠ m·∫≠t, ri√™ng t∆∞</th>
                <th rowspan="2">T·ªïng s·ªë h·ªôi, nh√≥m.</th>
                <th rowspan="2">C√¥ng khai</th>
                <th rowspan="2">K√≠n, b√≠ m·∫≠t, ri√™ng t∆∞</th>
                <th rowspan="2">H·ªôi, nh√≥m ph·ª©c t·∫°p</th>
                <th rowspan="2">H·ªôi, nh√≥m c√≥ l∆∞·ª£ng th√†nh vi√™n l·ªõn, ti·ªÅm ·∫©n nguy c∆° ƒë·ªëi v·ªõi ANQG</th>
                <th rowspan="2">H·ªôi nh√≥m ƒë√£ ƒêTCB</th>
                <th rowspan="2">H·ªôi, nh√≥m ƒë√£ x√°c ƒë·ªãnh, l√†m r√µ ƒë·ªëi t∆∞·ª£ng qu·∫£n tr·ªã</th>
                <th rowspan="2">CA</th>
                <th rowspan="2">KTNV</th>
                <th rowspan="2">QLNV</th>
                <th colspan="2">T·ªïng s·ªë tin cung c·∫•p</th>
                <th colspan="2">T·ªïng s·ªë tin x·ª≠ l√Ω</th>
            </tr>
            <tr>
                <th>VNV</th> <th>VLL</th>
                <th>VNV</th> <th>VLL</th>
                <th>VNV</th> <th>VLL</th>
                <th>VNV</th> <th>VLL</th>
                <th>VNV</th> <th>VLL</th>
                <th>VNV</th> <th>VLL</th>
                <th>VNV</th> <th>VLL</th>
            </tr>
            <tr class="guide-row">
                <td></td><td></td>
                <td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td>
                <td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td><td>19</td><td>20</td>
                <td>21</td><td>22</td><td>23</td><td>24</td><td>25</td><td>26</td><td>27</td><td>28</td><td>29</td><td>30</td>
                <td>31</td><td>32</td><td>33</td><td>34</td><td>35</td><td>36</td><td>37</td><td>38</td>
            </tr>
        </thead>
        <tbody id="table-body">
            </tbody>
        <tfoot id="table-foot">
            </tfoot>
    </table>
  </div>

  <div class="actions">
    <button class="btn btn-add" onclick="addNewRow()"><span>‚ûï</span> Th√™m d√≤ng</button>
    <button class="btn btn-save" onclick="saveData()"><span>üíæ</span> L∆∞u</button>
    <button class="btn btn-reset" onclick="resetForm()"><span>üóëÔ∏è</span> L√†m m·ªõi</button>
    <button class="btn btn-export" onclick="exportMainWord()"><span>üìÑ</span> Xu·∫•t Word</button>
  </div>
  
  <div class="archive-section">
    <div class="section-title">D·ªØ li·ªáu ƒë√£ l∆∞u tr·ªØ</div>
    <div class="archive-list-wrap">
      <table class="archive-list" id="archive-list"></table>
    </div>
  </div>
  
  <div class="aggregate-section">
    <div class="section-title">T·ªïng h·ª£p s·ªë li·ªáu</div>
    <div class="agg-search-row">
      <label>T·ª´ ng√†y:</label>
      <input type="date" id="agg-date-from">
      <label>ƒê·∫øn ng√†y:</label>
      <input type="date" id="agg-date-to">
      <button class="btn btn-view" onclick="searchByDateRange()">T√¨m ki·∫øm</button>
    </div>
    <div class="agg-results-list" id="agg-results"></div>
    <div style="text-align: center; margin-top: 10px;">
        <button class="btn btn-save" onclick="aggregateSelected()">T·ªïng h·ª£p c√°c m·ª•c ƒë√£ ch·ªçn</button>
    </div>
    <div class="agg-table-wrap" id="agg-table-wrap"></div>
  </div>

</div>

<script>
// To√†n b·ªô m√£ JavaScript t·ª´ phi√™n b·∫£n tr∆∞·ªõc ƒë∆∞·ª£c gi·ªØ nguy√™n v√¨ n√≥ ƒë√£ ·ªïn ƒë·ªãnh.
// C√°c thay ƒë·ªïi ch·ªâ n·∫±m ·ªü ph·∫ßn HTML v√† CSS ƒë·ªÉ t·ªëi ∆∞u giao di·ªán.
const NUM_COLS = 38;
const STORAGE_PREFIX = 'hoinhom_'; // Changed prefix to avoid conflicts

// RENDER & CALCULATION
function renderTable(data = []) {
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = '';
    if (data.length === 0) {
        addNewRow(false);
    } else {
        data.forEach(rowData => addNewRow(false, rowData));
    }
    renderFooter();
    calcTotal();
}

function renderFooter() {
    const tableFoot = document.getElementById('table-foot');
    let footHtml = '<tr class="total-row"><td colspan="2">T·ªïng c·ªông</td>';
    for(let c=3; c<=NUM_COLS; c++) {
        footHtml += `<td id="total_${c}">0</td>`;
    }
    footHtml += '</tr>';
    tableFoot.innerHTML = footHtml;
}

function addNewRow(recalc = true, rowData = null) {
    const tableBody = document.getElementById('table-body');
    const newRow = document.createElement('tr');
    newRow.className = 'data-row';
    
    const rowNum = tableBody.rows.length + 1;
    let rowHtml = `<td class="row-number">${rowNum} <button class="delete-row-btn" onclick="deleteCurrentRow(this)">X</button></td><td class="input-cell"><input type="text" placeholder="Nh·∫≠p ƒë∆°n v·ªã" value="${rowData ? rowData[0] : ''}"></td>`;
    for(let c=3; c<=NUM_COLS; c++) {
        const value = rowData ? rowData[c-2] : '';
        rowHtml += `<td class="input-cell"><input type="number" min="0" oninput="calcTotal()" value="${value}" /></td>`;
    }
    newRow.innerHTML = rowHtml;
    tableBody.appendChild(newRow);
    if(recalc) calcTotal();
}

function deleteCurrentRow(button) {
    if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d√≤ng n√†y?')) {
        button.closest('tr').remove();
        updateRowNumbers();
        calcTotal();
    }
}

function updateRowNumbers() {
    const rows = document.querySelectorAll('#table-body tr.data-row');
    rows.forEach((row, index) => {
        const cell = row.querySelector('.row-number');
        if (cell) {
            const btn = cell.querySelector('button');
            cell.innerHTML = `${index + 1} `;
            cell.appendChild(btn);
        }
    });
}

function calcTotal() {
    const rows = document.querySelectorAll('#table-body tr.data-row');
    for(let c=3; c<=NUM_COLS; c++) {
        let sum = 0;
        rows.forEach(row => {
            const input = row.querySelector(`td:nth-child(${c}) input`);
            if(input) sum += parseInt(input.value || 0);
        });
        document.getElementById(`total_${c}`).innerText = sum;
    }
}

function resetForm(ask=true) {
    if (ask && !confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu ƒëang nh·∫≠p tr√™n b·∫£ng?')) return;
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    renderTable([]);
}

// DATA MANAGEMENT
function saveData() {
    const date = document.getElementById('date').value;
    if(!date) return alert('Vui l√≤ng nh·∫≠p ng√†y b√°o c√°o!');
    let data = [];
    document.querySelectorAll('#table-body tr.data-row').forEach(row => {
        let rowData = [];
        let hasValue = false;
        row.querySelectorAll('input').forEach(input => {
            const val = input.value || '';
            rowData.push(val);
            if (val) hasValue = true;
        });
        if (hasValue) {
            data.push(rowData);
        }
    });
    localStorage.setItem(STORAGE_PREFIX + date, JSON.stringify(data));
    alert('ƒê√£ l∆∞u d·ªØ li·ªáu cho ng√†y '+formatDate(date));
    updateArchiveList();
}

function loadData(date) {
    date = date || document.getElementById('date').value;
    if(!date) return alert('Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ xem d·ªØ li·ªáu!');
    let data = localStorage.getItem(STORAGE_PREFIX + date);
    if(!data) {
        resetForm(false);
        return;
    }
    document.getElementById('date').value = date;
    renderTable(JSON.parse(data));
}

function updateArchiveList() {
    const tbl = document.getElementById('archive-list');
    let arr = [];
    for(let i=0; i<localStorage.length; i++) {
        let k = localStorage.key(i);
        if(k.startsWith(STORAGE_PREFIX)) arr.push(k.replace(STORAGE_PREFIX,''));
    }
    arr.sort((a,b)=>b.localeCompare(a));
    
    let html = (arr.length > 0) ? '' : '<div style="color:#888;padding:4px;text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o.</div>';
    if (arr.length > 0) {
        arr.forEach(d => {
            html += `<tr>
                <td>${formatDate(d)}</td>
                <td>
                    <div class="archive-row-actions">
                        <button class="btn btn-view btn-small" onclick="loadData('${d}')">üëÅÔ∏è</button>
                        <button class="btn btn-reset btn-small" style="background: #c0392b" onclick="deleteData('${d}')">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>`;
        });
    }
    tbl.innerHTML = html;
}

function deleteData(date) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn b√°o c√°o ng√†y ${formatDate(date)}?`)) return;
    localStorage.removeItem(STORAGE_PREFIX + date);
    updateArchiveList();
    if (document.getElementById('date').value === date) {
        resetForm(false);
    }
    alert('ƒê√£ x√≥a b√°o c√°o.');
}

function formatDate(d) {
    if(!d) return '';
    const [y,m,day] = d.split('-');
    return `${day}/${m}/${y}`;
}

// WORD EXPORT & AGGREGATION
function prepareTableForExport(originalTable) {
    const tableClone = originalTable.cloneNode(true);
    tableClone.querySelectorAll('input').forEach(input => {
        input.parentElement.innerText = input.value || '0';
    });
    tableClone.querySelectorAll('.delete-row-btn').forEach(btn => btn.remove());
    return tableClone;
}

function generateWordHtml(tableContent, title, subTitle) {
    let css = `@page WordSection1 { size: 1190.55pt 841.95pt; mso-page-orientation: landscape; margin:0.5in; } div.WordSection1 { page: WordSection1; } table { border-collapse: collapse; width:100%; font-size:9pt; table-layout: fixed; } th,td { border:1px solid #000; padding:2px; text-align:center; vertical-align:middle; word-wrap: break-word; } h1, h2 { text-align:center; font-family:'Times New Roman', Times, serif; margin: 5px 0; } h1 {font-size: 14pt; font-weight:bold;} h2 {font-size: 12pt;}
    th, .total-row, .guide-row, .row-number { background-color: #ffffff !important; color: #000000 !important; font-weight: bold; }`;
    
    const signatureHtml = `
    <table style="width:100%; border:none; margin-top:40px; font-size:12pt; font-weight:bold; font-family:'Times New Roman', Times, serif;">
        <tr>
            <td style="width:50%; text-align:center; border:none;">L√ÉNH ƒê·∫†O PH√ä DUY·ªÜT</td>
            <td style="width:50%; text-align:center; border:none;">C√ÅN B·ªò TH·ªêNG K√ä</td>
        </tr>
    </table>`;

    let html = `<html><head><meta charset="utf-8"><style>${css}</style></head><body><div class="WordSection1"><h1>${title}</h1><h2>${subTitle}</h2>${tableContent}${signatureHtml}</div></body></html>`;
    return html;
}

function exportMainWord() {
    const tableForExport = prepareTableForExport(document.getElementById('main-table'));
    const date = document.getElementById('date').value;
    const title = 'TH·ªêNG K√ä S·ªê LI·ªÜU H·ªòI NH√ìM TR√äN KGM';
    const subTitle = date ? `(Ng√†y ${formatDate(date)})` : '';
    const htmlContent = generateWordHtml(tableForExport.outerHTML, title, subTitle);
    saveAs(new Blob(['\ufeff', htmlContent], {type: 'application/msword'}), `ThongKe_${date || 'Moi'}.doc`);
}

function searchByDateRange() {
    document.getElementById('agg-table-wrap').innerHTML = '';
    const fromDate = document.getElementById('agg-date-from').value;
    const toDate = document.getElementById('agg-date-to').value;

    if (!fromDate || !toDate) {
        return alert('Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c!');
    }
    if (fromDate > toDate) {
        return alert('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c!');
    }
    let arr = [];
    for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        if (key.startsWith(STORAGE_PREFIX)) {
            let reportDate = key.replace(STORAGE_PREFIX, '');
            if (reportDate >= fromDate && reportDate <= toDate) {
                arr.push(reportDate);
            }
        }
    }
    arr.sort((a, b) => b.localeCompare(a));
    let html = (arr.length > 0) ? '<form id="agg-form"><table style="width:100%; table-layout: auto;">' : `<div style="color:#888;padding:4px; text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ ${formatDate(fromDate)} ƒë·∫øn ${formatDate(toDate)}.</div>`;
    if (arr.length > 0) {
        arr.forEach(d => {
            html += `<tr><td><input class="agg-checkbox" type="checkbox" name="agg" value="${d}"></td><td>${formatDate(d)}</td></tr>`;
        });
        html += '</table></form>';
    }
    document.getElementById('agg-results').innerHTML = html;
}

function aggregateSelected() {
    const form = document.getElementById('agg-form');
    if(!form) return alert('Vui l√≤ng t√¨m ki·∫øm theo ng√†y tr∆∞·ªõc!');
    const checked = Array.from(form.elements['agg']).filter(e=>e.checked).map(e=>e.value);
    if(checked.length===0) return alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 b√°o c√°o ƒë·ªÉ t·ªïng h·ª£p!');
    
    const mergedData = new Map();

    checked.forEach(date => {
        let data = JSON.parse(localStorage.getItem(STORAGE_PREFIX + date) || '[]');
        data.forEach(rowData => {
            const unitName = rowData[0].trim();
            if (!unitName) return;

            const numericalData = rowData.slice(1).map(val => parseInt(val || 0));

            if (mergedData.has(unitName)) {
                const existingData = mergedData.get(unitName);
                for (let i = 0; i < numericalData.length; i++) {
                    existingData[i] += numericalData[i];
                }
            } else {
                mergedData.set(unitName, numericalData);
            }
        });
    });

    let aggData = [];
    mergedData.forEach((values, unitName) => {
        aggData.push([unitName, ...values]);
    });
    
    aggData.sort((a, b) => a[0].localeCompare(b[0]));

    const aggTable = document.getElementById('main-table').cloneNode(true);
    aggTable.id = 'agg-table';
    const aggBody = aggTable.querySelector('tbody');
    aggBody.innerHTML = '';
    
    aggData.forEach((rowData, index) => {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td class="row-number">${index + 1}</td><td>${rowData[0]}</td>`; 
        for(let c = 1; c < rowData.length; c++) {
            tr.innerHTML += `<td>${rowData[c] || '0'}</td>`;
        }
        aggBody.appendChild(tr);
    });
    
    const aggFoot = aggTable.querySelector('tfoot');
    let totals = Array(NUM_COLS - 1).fill(0);
    
    aggData.forEach(rowData => {
        for (let c = 1; c < rowData.length; c++) {
            totals[c-1] += parseInt(rowData[c] || 0);
        }
    });

    aggFoot.innerHTML = `<tr class="total-row"><td colspan="2">T·ªïng c·ªông</td>${totals.map(t => `<td>${t}</td>`).join('')}</tr>`;

    const exportButtonHtml = `<div style="margin-top: 15px; text-align: center;"><button class="btn btn-export" onclick="exportAggregatedWord()"><span>üìÑ</span> Xu·∫•t Word T·ªïng H·ª£p</button></div>`;
    
    document.getElementById('agg-table-wrap').innerHTML = `<h4 style="color: #1976d2; text-align: center;">K·∫øt qu·∫£ t·ªïng h·ª£p t·ª´ ${checked.length} b√°o c√°o</h4>${aggTable.outerHTML}${exportButtonHtml}`;
}

function exportAggregatedWord() {
    const table = document.getElementById('agg-table');
    if (!table) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu t·ªïng h·ª£p ƒë·ªÉ xu·∫•t!');
    
    const tableForExport = prepareTableForExport(table);
    const fromDate = document.getElementById('agg-date-from').value;
    const toDate = document.getElementById('agg-date-to').value;
    const title = 'TH·ªêNG K√ä T·ªîNG H·ª¢P S·ªê LI·ªÜU H·ªòI NH√ìM TR√äN KGM';
    const subTitle = (fromDate && toDate) ? `(T·ª´ ng√†y ${formatDate(fromDate)} ƒë·∫øn ${formatDate(toDate)})` : '(T·ªïng h·ª£p)';
    const htmlContent = generateWordHtml(tableForExport.outerHTML, title, subTitle);
    const fileName = `TongHop_HoiNhom_${fromDate}_${toDate}.doc`;
    saveAs(new Blob(['\ufeff', htmlContent], {type: 'application/msword'}), fileName);
}

// --- INITIAL LOAD ---
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
  renderTable([]);
  updateArchiveList();
});
</script>
</body>
</html>