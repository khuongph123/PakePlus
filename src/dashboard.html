<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - H·ªá Th·ªëng Qu·∫£n L√Ω</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #eef2f5; color: #333; font-family: 'Roboto', sans-serif; }
    #dashboard-container { display: flex; flex-direction: column; align-items: center; width: 100%; min-height: 100vh; }
    
    header { background: linear-gradient(to right, #1d62f0, #1e90ff); width: 100%; padding: 1.5rem 1rem; color: white; }
    header h1 { font-size: 1.7rem; text-align: center; margin-bottom: 1.5rem; }
    
    .controls-wrapper { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
    .btn-group, .single-day-manager, .report-generator {
        background: rgba(255,255,255,0.1); padding: 0.75rem 1rem; border-radius: 10px;
        display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    .btn { padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; color: white; transition: background 0.3s ease; text-decoration: none; }
    .btn-export { background: #0cc15d; }
    .btn-import { background: #5f6ef8; }
    .single-day-manager input[type="date"], .report-generator input[type="date"] { padding: 6px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.9rem; }
    .single-day-manager label, .report-generator label { font-weight: 500; font-size: 0.9rem; }
    .btn-report { background: #ff9800; }
    
    main { max-width: 1300px; width: 100%; display: flex; justify-content: center; flex-grow: 1; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 2rem; padding: 2.5rem 2rem; width: 100%; }
    .card { padding: 2.5rem 1.5rem; text-align: center; font-weight: 700; color: white; border-radius: 16px; font-size: 1.4rem; transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; min-height: 140px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-decoration: none; }
    .card:hover { transform: translateY(-8px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .color-1 { background-color: #3f51b5; } .color-2 { background-color: #009688; } .color-3 { background-color: #e91e63; }
    .color-4 { background-color: #9c27b0; } .color-6 { background-color: #f44336; }
    
    footer { width: 100%; text-align: center; padding: 1.5rem; color: #777; font-size: 0.9rem; }
  </style>
</head>
<body>
<a href="index.html" class="btn" style="position: absolute; top: 15px; left: 15px; background-color: rgba(0,0,0,0.2); padding: 8px 15px; font-size: 0.9rem;">‚¨ÖÔ∏è Quay l·∫°i</a>
  <div id="dashboard-container">
    <header>
      <h1>H·ªÜ TH·ªêNG QU·∫¢N L√ù S·ªê LI·ªÜU NVCB</h1>
      <div class="controls-wrapper">
          <div class="btn-group">
            <button class="btn btn-export" onclick="exportBackupData()">üì• Xu·∫•t To√†n B·ªô</button>
            <button class="btn btn-import" onclick="document.getElementById('import-file-backup').click()">üì§ Nh·∫≠p Sao L∆∞u</button>
            <input type="file" id="import-file-backup" style="display: none;" accept=".json" onchange="importBackupData(event)">
          </div>
          <div class="single-day-manager">
            <label for="single-day-date">Ch·ªçn ng√†y:</label>
            <input type="date" id="single-day-date">
            <button class="btn btn-export" style="background-color: #00bcd4;" onclick="exportSingleDayData()">üìù Xu·∫•t D·ªØ Li·ªáu Ng√†y</button>
            <button class="btn btn-import" style="background-color: #8bc34a;" onclick="document.getElementById('import-file-single-day').click()">üì• Nh·∫≠p D·ªØ Li·ªáu Ng√†y</button>
            <input type="file" id="import-file-single-day" style="display: none;" accept=".json" onchange="importSingleDayData(event)">
          </div>
          <div class="report-generator">
            <label for="report-start-date">T·ª´ ng√†y:</label> <input type="date" id="report-start-date">
            <label for="report-end-date">ƒê·∫øn ng√†y:</label> <input type="date" id="report-end-date">
            <button class="btn btn-report" onclick="exportAggregatedReport()">üìä Xu·∫•t B√°o C√°o</button>
            <button class="btn btn-import" onclick="document.getElementById('import-file-report').click()">üì§ Nh·∫≠p B√°o C√°o</button>
            <input type="file" id="import-file-report" style="display: none;" accept=".json" onchange="importAggregatedReport(event)">
          </div>
      </div>
    </header>
    <main>
        <div class="grid">
            <a href="hoinhom.html" class="card color-1">TH·ªêNG K√ä<br>S·ªê LI·ªÜU H·ªòI, NH√ìM V√Ä VAI OO</a>
            <a href="dtcb.html" class="card color-2">TH·ªêNG K√ä<br>S·ªê LI·ªÜU ƒêTCB</a>
            <a href="nat.html" class="card color-3">TH·ªêNG K√ä<br>NAT V√Ä HTBM</a>
            <a href="ctv.html" class="card color-4">TH·ªêNG K√ä<br>S·ªê LI·ªÜU CTV</a>
            <a href="csbm.html" class="card color-6">TH·ªêNG K√ä<br>S·ªê LI·ªÜU CSBM</a>
            <a href="thongketonghop.html" class="card color-1">TH·ªêNG K√ä<br>T·ªîNG H·ª¢P</a>
        </div>
    </main>
    <footer><p>T√°c gi·∫£: D∆∞∆°ng VƒÉn Kh∆∞∆°ng</p></footer>
  </div>

<script>
// === KHAI B√ÅO C√ÅC TI·ªÄN T·ªê (PREFIX) CHO T·ª™NG MODULE ===
const ALL_MODULE_PREFIXES = [
    'hoinhom_', 
    'dtcb_',    
    'nat_',     
    'ctv_',     
    'csbm_',    
    'tonghop_'  
];

// === C√ÅC H√ÄM X·ª¨ L√ù D·ªÆ LI·ªÜU ===

/**
 * H√ÄM C·ªòT L√ïI: H·ª£p nh·∫•t d·ªØ li·ªáu m·ªõi v√†o d·ªØ li·ªáu c≈© b·∫±ng c√°ch c·ªông d·ªìn.
 * ƒê∆∞·ª£c s·ª≠ d·ª•ng b·ªüi 'Nh·∫≠p D·ªØ Li·ªáu Ng√†y' v√† 'Nh·∫≠p B√°o C√°o'.
 */
function mergeDataForKey(key, importedRows) {
    const existingDataJSON = localStorage.getItem(key);
    if (!existingDataJSON) {
        localStorage.setItem(key, JSON.stringify(importedRows));
        return;
    }
    const existingRows = JSON.parse(existingDataJSON);
    const combinedData = new Map();
    for (const row of existingRows) {
        const unitName = row[0] || row[12];
        if (unitName) combinedData.set(unitName, row);
    }
    for (const row of importedRows) {
        const unitName = row[0] || row[12];
        if (!unitName) continue;
        if (combinedData.has(unitName)) {
            const existingRow = combinedData.get(unitName);
            const newRow = [...existingRow];
            for(let i = 1; i < row.length; i++) {
                if (key.startsWith('tonghop_') && i === 12) continue;
                newRow[i] = (parseFloat(existingRow[i]) || 0) + (parseFloat(row[i]) || 0);
            }
            combinedData.set(unitName, newRow);
        } else {
            combinedData.set(unitName, row);
        }
    }
    const finalMergedRows = Array.from(combinedData.values());
    localStorage.setItem(key, JSON.stringify(finalMergedRows));
}

/**
 * Ch·ª©c nƒÉng: Xu·∫•t to√†n b·ªô d·ªØ li·ªáu c·ªßa t·∫•t c·∫£ c√°c module ra file backup.
 */
function exportBackupData() {
    const allData = {};
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (ALL_MODULE_PREFIXES.some(prefix => key.startsWith(prefix))) {
            try { allData[key] = JSON.parse(localStorage.getItem(key)); } catch(e) { /* B·ªè qua l·ªói */ }
        }
    }
    if (Object.keys(allData).length === 0) { return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!'); }
    const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-T:]/g, "");
    saveAs(blob, `NVCB_Backup_ToanBo_${timestamp}.json`);
    alert('ƒê√£ xu·∫•t to√†n b·ªô d·ªØ li·ªáu th√†nh c√¥ng!');
}

/**
 * Ch·ª©c nƒÉng: Nh·∫≠p file backup. S·∫Ω X√ìA S·∫†CH d·ªØ li·ªáu c≈© v√† GHI ƒê√à b·∫±ng d·ªØ li·ªáu m·ªõi.
 */
function importBackupData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const dataFromFile = JSON.parse(e.target.result);
            if (dataFromFile.reportInfo) { throw new Error("File kh√¥ng h·ª£p l·ªá! ƒê√¢y l√† file B√°o c√°o."); }
            if (!confirm(`C·∫¢NH B√ÅO: Thao t√°c n√†y s·∫Ω X√ìA S·∫†CH d·ªØ li·ªáu c≈© v√† GHI ƒê√à b·∫±ng d·ªØ li·ªáu t·ª´ file "${file.name}".\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. B·∫°n c√≥ ch·∫Øc mu·ªën ti·∫øp t·ª•c?`)) {
                return;
            }
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (ALL_MODULE_PREFIXES.some(prefix => key.startsWith(prefix))) { localStorage.removeItem(key); }
            }
            for (const key in dataFromFile) {
                if (Object.prototype.hasOwnProperty.call(dataFromFile, key) && ALL_MODULE_PREFIXES.some(p => key.startsWith(p))) {
                    localStorage.setItem(key, JSON.stringify(dataFromFile[key]));
                }
            }
            alert('Kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ file sao l∆∞u th√†nh c√¥ng!');
        } catch (error) {
            alert('L·ªói: ' + error.message);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

/**
 * Ch·ª©c nƒÉng: Xu·∫•t d·ªØ li·ªáu c·ªßa t·∫•t c·∫£ module cho m·ªôt ng√†y duy nh·∫•t.
 */
function exportSingleDayData() {
    const dateValue = document.getElementById('single-day-date').value;
    if (!dateValue) { return alert('Vui l√≤ng ch·ªçn m·ªôt ng√†y c·ª• th·ªÉ ƒë·ªÉ xu·∫•t.'); }
    const dayData = {};
    let dataFound = false;
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const prefix = ALL_MODULE_PREFIXES.find(p => key.startsWith(p));
        if (prefix && key.substring(prefix.length) === dateValue) {
            try { dayData[key] = JSON.parse(localStorage.getItem(key)); dataFound = true; } catch (e) { /* B·ªè qua */ }
        }
    }
    if (!dataFound) { return alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o cho ng√†y ƒë√£ ch·ªçn.'); }
    const blob = new Blob([JSON.stringify(dayData, null, 2)], { type: 'application/json' });
    saveAs(blob, `NVCB_Ngay_${dateValue}.json`);
    alert(`ƒê√£ xu·∫•t th√†nh c√¥ng d·ªØ li·ªáu cho ng√†y ${dateValue}.`);
}

/**
 * === H√ÄM ƒê∆Ø·ª¢C B·ªî SUNG ƒê·ªÇ S·ª¨A L·ªñI ===
 * Ch·ª©c nƒÉng: Nh·∫≠p file d·ªØ li·ªáu c·ªßa m·ªôt ng√†y. S·∫Ω C·ªòNG D·ªíN d·ªØ li·ªáu.
 */
function importSingleDayData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const dataFromFile = JSON.parse(e.target.result);
            if (dataFromFile.reportInfo) { throw new Error("File kh√¥ng h·ª£p l·ªá! ƒê√¢y l√† file B√°o c√°o. Vui l√≤ng d√πng ch·ª©c nƒÉng 'Nh·∫≠p B√°o C√°o'."); }
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën nh·∫≠p v√† c·ªông d·ªìn d·ªØ li·ªáu t·ª´ file b√°o c√°o ng√†y "${file.name}"?`)) {
                return;
            }
            for (const key in dataFromFile) {
                if (Object.prototype.hasOwnProperty.call(dataFromFile, key) && ALL_MODULE_PREFIXES.some(p => key.startsWith(p))) {
                    mergeDataForKey(key, dataFromFile[key]);
                }
            }
            alert('Nh·∫≠p v√† c·ªông d·ªìn d·ªØ li·ªáu t·ª´ file b√°o c√°o ng√†y th√†nh c√¥ng!');
        } catch (error) {
            alert('L·ªói: ' + error.message);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

/**
 * Ch·ª©c nƒÉng: Xu·∫•t b√°o c√°o t·ªïng h·ª£p d·ªØ li·ªáu t·ª´ nhi·ªÅu ng√†y.
 */
function exportAggregatedReport() {
    const startDateString = document.getElementById('report-start-date').value;
    const endDateString = document.getElementById('report-end-date').value;
    if (!startDateString || !endDateString) { return alert("Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c."); }
    if (startDateString > endDateString) { return alert("Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n ng√†y k·∫øt th√∫c."); }
    
    const aggregatedData = {};
    let dataFound = false;
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const prefix = ALL_MODULE_PREFIXES.find(p => key.startsWith(p));
        if (prefix) {
            const dateStr = key.substring(prefix.length);
            if (dateStr >= startDateString && dateStr <= endDateString) {
                dataFound = true;
                const moduleName = prefix.slice(0, -1);
                if (!aggregatedData[moduleName]) aggregatedData[moduleName] = new Map();
                try {
                    const rows = JSON.parse(localStorage.getItem(key));
                    for (const row of rows) {
                        const unitName = row[0] || row[12];
                        if (!unitName) continue;
                        if (aggregatedData[moduleName].has(unitName)) {
                            const existingRow = aggregatedData[moduleName].get(unitName);
                            const summedRow = [...existingRow];
                            for(let j = 1; j < row.length; j++) {
                                if (prefix === 'tonghop_' && j === 12) continue;
                                summedRow[j] = (parseFloat(existingRow[j]) || 0) + (parseFloat(row[j]) || 0);
                            }
                            aggregatedData[moduleName].set(unitName, summedRow);
                        } else {
                            aggregatedData[moduleName].set(unitName, row);
                        }
                    }
                } catch(e) { /* B·ªè qua */ }
            }
        }
    }
    if (!dataFound) { return alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o trong kho·∫£ng ng√†y ƒë√£ ch·ªçn."); }
    
    const finalReport = { reportInfo: { type: "B√°o c√°o t·ªïng h·ª£p", period: `T·ª´ ${startDateString} ƒë·∫øn ${endDateString}` }, data: {} };
    for(const moduleName in aggregatedData) {
        finalReport.data[moduleName] = Array.from(aggregatedData[moduleName].values());
    }
    const blob = new Blob([JSON.stringify(finalReport, null, 2)], { type: 'application/json' });
    saveAs(blob, `BaoCaoTongHop_${startDateString}_den_${endDateString}.json`);
    alert(`ƒê√£ xu·∫•t b√°o c√°o t·ªïng h·ª£p th√†nh c√¥ng!`);
}

/**
 * Ch·ª©c nƒÉng: Nh·∫≠p file b√°o c√°o t·ªïng h·ª£p. S·∫Ω C·ªòNG D·ªíN d·ªØ li·ªáu.
 */
function importAggregatedReport(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const dataFromFile = JSON.parse(e.target.result);
            if (!dataFromFile.reportInfo || !dataFromFile.data) { throw new Error("File kh√¥ng h·ª£p l·ªá! ƒê√¢y kh√¥ng ph·∫£i l√† file B√°o c√°o T·ªïng h·ª£p."); }
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën nh·∫≠p d·ªØ li·ªáu t·ª´ B√°o c√°o T·ªïng h·ª£p "${file.name}"?`)) {
                return;
            }
            const periodString = dataFromFile.reportInfo.period;
            const endDate = periodString.split(' ').pop();
            if (!endDate || !/^\d{4}-\d{2}-\d{2}$/.test(endDate)) { throw new Error("Kh√¥ng th·ªÉ x√°c ƒë·ªãnh ng√†y k·∫øt th√∫c t·ª´ file b√°o c√°o."); }
            for (const moduleName in dataFromFile.data) {
                const prefix = moduleName + '_';
                if (ALL_MODULE_PREFIXES.includes(prefix)) {
                    mergeDataForKey(prefix + endDate, dataFromFile.data[moduleName]);
                }
            }
            alert('Nh·∫≠p v√† c·ªông d·ªìn d·ªØ li·ªáu t·ª´ B√°o c√°o T·ªïng h·ª£p th√†nh c√¥ng!');
        } catch (error) {
            alert('L·ªói: ' + error.message);
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

</script>
</body>
</html>